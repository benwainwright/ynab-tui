{"version":3,"sources":["../../../src/test-support/cli.ts"],"sourcesContent":["// Shamelessly borrowed from https://www.lekoarts.de/garden/how-to-test-cli-output-in-jest-vitest/\nimport { join } from 'path'\nimport { createLogsMatcher } from './logs-matcher.ts'\nimport { execaSync } from 'execa'\nimport type { ExecaSyncError } from 'execa'\n\nimport strip from 'strip-ansi'\n\nconst builtCliLocation = join(__dirname, '..', 'dist', 'entry.js')\n\ntype CreateLogsMatcherReturn = ReturnType<typeof createLogsMatcher>\n\nexport type InvokeResult = [\n  exitCode: number | undefined,\n  logsMatcher: CreateLogsMatcherReturn,\n]\n\nexport class CLI {\n  public constructor(private readonly cwd: string) {}\n  public invoke(args: Array<string>): InvokeResult {\n    const NODE_ENV = 'production'\n    try {\n      const results = execaSync(\n        process.execPath,\n        [builtCliLocation].concat(args),\n        {\n          cwd: this.cwd,\n          env: { NODE_ENV },\n        },\n      )\n      return [\n        results.exitCode,\n        createLogsMatcher(\n          strip(results.stderr.toString() + results.stdout.toString()),\n        ),\n      ]\n    } catch (e) {\n      const execaError = e as ExecaSyncError\n      return [\n        execaError.exitCode,\n        createLogsMatcher(strip(execaError.stdout?.toString() || ``)),\n      ]\n    }\n  }\n}\n"],"names":["join","createLogsMatcher","execaSync","strip","builtCliLocation","__dirname","CLI","cwd","invoke","args","NODE_ENV","results","process","execPath","concat","env","exitCode","stderr","toString","stdout","e","execaError"],"mappings":"AAAA,kGAAkG;AAClG,SAASA,IAAI,QAAQ,OAAM;AAC3B,SAASC,iBAAiB,4BAA2B;AACrD,SAASC,SAAS,QAAQ,QAAO;AAGjC,OAAOC,WAAW,aAAY;AAE9B,MAAMC,mBAAmBJ,KAAKK,WAAW,MAAM,QAAQ;AASvD,OAAO,MAAMC;;IACX,YAAmB,AAAiBC,GAAW,CAAE;aAAbA,MAAAA;IAAc;IAC3CC,OAAOC,IAAmB,EAAgB;QAC/C,MAAMC,WAAW;QACjB,IAAI;YACF,MAAMC,UAAUT,UACdU,QAAQC,QAAQ,EAChB;gBAACT;aAAiB,CAACU,MAAM,CAACL,OAC1B;gBACEF,KAAK,IAAI,CAACA,GAAG;gBACbQ,KAAK;oBAAEL;gBAAS;YAClB;YAEF,OAAO;gBACLC,QAAQK,QAAQ;gBAChBf,kBACEE,MAAMQ,QAAQM,MAAM,CAACC,QAAQ,KAAKP,QAAQQ,MAAM,CAACD,QAAQ;aAE5D;QACH,EAAE,OAAOE,GAAG;YACV,MAAMC,aAAaD;YACnB,OAAO;gBACLC,WAAWL,QAAQ;gBACnBf,kBAAkBE,MAAMkB,WAAWF,MAAM,EAAED,cAAc,CAAC,CAAC;aAC5D;QACH;IACF;AACF"}